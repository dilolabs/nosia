<% is_generating = chat.persisted? && chat.generating %>

<%= form_with(model: chat, url: chats_path, data: { controller: "chat-input" }, id: "chat-form", class: "w-full") do |form| %>
  <%= form.label :prompt, "Summarize the latest…", class: "sr-only" %>

  <%# Hidden fields for MCP server IDs - will be populated by JS %>
  <div id="mcp-server-hidden-fields"></div>

  <div class="relative w-full" data-chat-input-target="wrapper">
    <%= form.text_area :prompt, rows: 2, autofocus: !is_generating, placeholder: is_generating ? "AI is generating..." : "Ask anything…", disabled: is_generating, data: { chat_input_target: "textarea", action: "input->chat-input#autogrow keydown->chat-input#handleKeys" }, class: "n-form-chat" %>

    <% if is_generating %>
      <%# Bouton Stop pendant la génération %>
      <%= button_to stop_chat_path(chat), method: :post, class: "n-btn-chat n-btn-stop-chat" do %>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-4 w-4">
          <rect x="6" y="6" width="12" height="12" rx="1"/>
        </svg>
      <% end %>
    <% else %>
      <%# Bouton Send normal %>
      <%= form.button type: :submit,
        data: { action: "chat-input#submit" },
        class: "n-btn-chat n-btn-chat-send" do %>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="1.8" class="h-4 w-4">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M6 12 3.269 3.125A59.77 59.77 0 0 1 21.485 12 59.77 59.77 0 0 1 3.27 20.875L6 12Zm0 0h7.5"/>
        </svg>
      <% end %>
    <% end %>
  </div>

  <ul>
    <% chat.errors.each do |error| %>
      <li><%= error.full_message %></li>
    <% end %>
  </ul>

  <%# MCP Server Selection %>
  <% unless chat.persisted? %>
    <% available_mcp_servers = Current.account.mcp_servers.enabled.where(status: 'ready') %>
    <% if available_mcp_servers.any? %>
      <div class="mt-3">
        <details class="group">
          <summary class="cursor-pointer list-none flex items-center gap-2 text-xs text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-200 transition-colors">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
            </svg>
            <span>MCP Tools (<span id="mcp-selected-count">0</span> selected)</span>
            <svg class="w-3.5 h-3.5 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </summary>

          <div class="mt-2 grid grid-cols-1 gap-2" data-controller="mcp-selection">
            <% available_mcp_servers.each do |server| %>
              <label class="flex items-center gap-2 rounded-lg border border-neutral-200 dark:border-neutral-700 p-2 cursor-pointer hover:bg-neutral-50 dark:hover:bg-neutral-900/50 transition-colors">
                <input type="checkbox" name="mcp_server_ids[]" value="<%= server.id %>" data-action="change->mcp-selection#updateCount" class="w-3.5 h-3.5 rounded border-neutral-300 text-blue-600 focus:ring-blue-500 dark:border-neutral-600 dark:bg-neutral-800">
                <div class="flex-1 min-w-0">
                  <div class="font-medium text-xs text-neutral-900 dark:text-neutral-100 truncate"><%= server.name %></div>
                </div>
                <span class="inline-flex items-center gap-1 rounded-full bg-green-100 px-1.5 py-0.5 text-[10px] font-medium text-green-800 dark:bg-green-900/30 dark:text-green-400 flex-shrink-0">
                  <span class="h-1 w-1 rounded-full bg-green-600"></span>
                  <%= server.latency_ms %>ms
                </span>
              </label>
            <% end %>
          </div>
        </details>
      </div>
    <% end %>
  <% end %>

  <div class="mt-2 flex items-center justify-between text-xs text-neutral-500 dark:text-neutral-400">
    <span>Enter to send · Shift+Enter for a line break</span>
    <% if chat.persisted? %>
      <button type="button" onclick="document.getElementById('mcp-selector-modal').classList.remove('hidden')" class="inline-flex items-center gap-1 text-blue-600 dark:text-blue-400 hover:underline">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
        </svg>
        MCP (<%= chat.mcp_servers.count %>)
      </button>
    <% end %>
  </div>
<% end %>
